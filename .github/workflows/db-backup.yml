name: Supabase Backup

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v6
      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client
      - name: Dump database
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          if [ -z "$SUPABASE_DB_URL" ]; then
            echo "SUPABASE_DB_URL secret missing" >&2
            exit 1
          fi
          mkdir -p backups
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          echo "Creating backup with timestamp: $TIMESTAMP"
          pg_dump --no-owner --clean "$SUPABASE_DB_URL" | gzip > "backups/supabase-dump-${TIMESTAMP}.sql.gz"
          echo "BACKUP_FILE=backups/supabase-dump-${TIMESTAMP}.sql.gz" >> $GITHUB_ENV
          ls -lh backups/
      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: supabase-backup-${{ github.run_id }}
          path: backups/supabase-dump-*.sql.gz
          retention-days: 30
      - name: Report summary
        if: success()
        run: |
          echo "## ðŸ’¾ Supabase Backup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date:** $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" >> $GITHUB_STEP_SUMMARY
          if [ -f "$BACKUP_FILE" ]; then
            SIZE=$(ls -lh "$BACKUP_FILE" | awk '{print $5}')
            echo "- **Backup Size:** $SIZE (compressed)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Retention:** 30 days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Backup completed successfully" >> $GITHUB_STEP_SUMMARY

      - name: Create failure issue
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            const title = `ðŸ”´ Supabase Backup Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `## Workflow Failure\n\n**Workflow:** Supabase Backup\n**Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n**Triggered by:** ${context.eventName}\n\n### Likely Causes\n- Missing \`SUPABASE_DB_URL\` secret\n- Database connection issues\n- PostgreSQL client errors\n\nPlease check the workflow logs for details.`;

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'workflow-failure,db-backup'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['workflow-failure', 'db-backup', 'automated']
              });
            }
