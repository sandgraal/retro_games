name: Catalog Data Refresh

on:
    schedule:
        # Run daily at 3 AM UTC for catalog updates
        - cron: "0 3 * * *"
    workflow_dispatch:
        inputs:
            source:
                description: "Data source to refresh (igdb, rawg, all)"
                required: false
                default: "all"
            limit:
                description: "Maximum games to process per source"
                required: false
                default: "100"
            dry_run:
                description: "Set to true for dry run (no database writes)"
                required: false
                default: "false"

env:
    CATALOG_LIMIT: ${{ github.event.inputs.limit || '100' }}
    CATALOG_SOURCE: ${{ github.event.inputs.source || 'all' }}
    CATALOG_DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}

jobs:
    refresh-catalog:
        runs-on: ubuntu-latest
        timeout-minutes: 45
        permissions:
            contents: read
            issues: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20.19"
                  cache: npm

            - name: Install dependencies
              run: npm ci

            - name: Run catalog ingest
              id: ingest
              env:
                  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
                  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
                  IGDB_CLIENT_ID: ${{ secrets.IGDB_CLIENT_ID }}
                  IGDB_CLIENT_SECRET: ${{ secrets.IGDB_CLIENT_SECRET }}
                  RAWG_API_KEY: ${{ secrets.RAWG_API_KEY }}
              run: |
                  echo "ðŸŽ® Starting catalog refresh..."
                  echo "Source: $CATALOG_SOURCE"
                  echo "Limit: $CATALOG_LIMIT"
                  echo "Dry run: $CATALOG_DRY_RUN"

                  # Run catalog ingest (once mode)
                  npm run ingest:catalog 2>&1 | tee ingest-output.log

                  # Extract stats for summary
                  GAMES_PROCESSED=$(grep -oP 'Processed \K\d+' ingest-output.log || echo "0")
                  echo "games_processed=$GAMES_PROCESSED" >> $GITHUB_OUTPUT
              continue-on-error: true

            - name: Audit missing covers
              if: success()
              env:
                  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
                  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
              run: |
                  echo "ðŸ–¼ï¸ Checking for missing covers..."
                  npm run audit:covers -- --limit 50 2>&1 | tee covers-output.log || true
              continue-on-error: true

            - name: Create issue on failure
              if: failure()
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      let logContent = '';
                      try {
                        logContent = fs.readFileSync('ingest-output.log', 'utf8').slice(-2000);
                      } catch (e) {
                        logContent = 'No log file available';
                      }

                      await github.rest.issues.create({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        title: 'ðŸš¨ Catalog refresh failed',
                        body: `## Catalog Data Refresh Failed\n\n` +
                          `**Workflow run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n` +
                          `**Triggered by:** ${context.eventName}\n` +
                          `**Time:** ${new Date().toISOString()}\n\n` +
                          `### Last 2000 chars of log output:\n` +
                          '```\n' + logContent + '\n```\n\n' +
                          `### Action Required\n` +
                          `1. Check API credentials (IGDB, RAWG)\n` +
                          `2. Verify Supabase connection\n` +
                          `3. Review rate limits\n`,
                        labels: ['bug', 'data-pipeline', 'automated']
                      });

    refresh-prices:
        runs-on: ubuntu-latest
        needs: refresh-catalog
        if: always()
        timeout-minutes: 30

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20.19"
                  cache: npm

            - name: Install dependencies
              run: npm ci

            - name: Refresh price data
              env:
                  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
                  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
                  EBAY_APP_ID: ${{ secrets.EBAY_APP_ID }}
                  EBAY_CERT_ID: ${{ secrets.EBAY_CERT_ID }}
              run: |
                  echo "ðŸ’° Refreshing price data..."
                  npm run prices:update -- --limit 50 2>&1 | tee prices-output.log || true

            - name: Summary
              run: |
                  echo "## ðŸ“Š Catalog Refresh Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Run Date | $(date -u '+%Y-%m-%d %H:%M UTC') |" >> $GITHUB_STEP_SUMMARY
                  echo "| Catalog Job | ${{ needs.refresh-catalog.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Price Job | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
