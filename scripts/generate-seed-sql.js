#!/usr/bin/env node
const fs = require("fs");
const path = require("path");
const { parse } = require("csv-parse/sync");

const ROOT = path.resolve(__dirname, "..");
const csvPath = path.join(ROOT, "games.csv");
const outputPath = path.join(ROOT, "supabase", "seed.sql");

if (!fs.existsSync(csvPath)) {
  console.error("games.csv not found at", csvPath);
  process.exit(1);
}

function slugify(value) {
  return (value || "")
    .toString()
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "")
    .slice(0, 60);
}

function escapeLiteral(value) {
  if (value === null || value === undefined || value === "") return "null";
  return `'${value.replace(/'/g, "''")}'`;
}

function numberLiteral(value, digits = 2) {
  if (value === null || value === undefined || Number.isNaN(value)) return "null";
  return Number(value).toFixed(digits);
}

const csvContent = fs.readFileSync(csvPath, "utf8");
const records = parse(csvContent, {
  columns: true,
  skip_empty_lines: true,
  relax_column_count: true,
});

const platforms = new Map();
const genres = new Map();
const games = [];

records.forEach((row, index) => {
  const name = row["Game Name"]?.trim();
  if (!name) return;
  const platformName = row["Platform"]?.trim() || "Unknown";
  const platformSlug = slugify(platformName) || `platform-${index}`;
  if (!platforms.has(platformSlug)) platforms.set(platformSlug, platformName);

  const genreList = row["Genre"]
    ? row["Genre"]
        .split(",")
        .map((g) => g.trim())
        .filter(Boolean)
    : [];
  genreList.forEach((g) => {
    const key = g.toLowerCase();
    if (!genres.has(key)) genres.set(key, g);
  });

  const rating = row["Rating"] ? parseFloat(row["Rating"]) : null;
  const releaseYear = row["Release Year"] ? parseInt(row["Release Year"], 10) : null;
  const cover = row["Cover"]?.trim();
  const details = row["Details"]?.trim();

  games.push({
    name,
    platformSlug,
    rating,
    ratingCategory: row["Rating Category"]?.trim() || null,
    releaseYear: Number.isNaN(releaseYear) ? null : releaseYear,
    playerMode: row["Player Mode"]?.trim() || null,
    region: row["Region"]?.trim() || null,
    notes: row["Notes"]?.trim() || null,
    playerCount: row["Player Count"]?.trim() || null,
    cover,
    details,
    genres: genreList,
  });
});

const lines = [];
lines.push("-- Auto-generated by scripts/generate-seed-sql.js");
lines.push("-- Generated: " + new Date().toISOString());
lines.push("begin;");
lines.push('create extension if not exists "pgcrypto";');

lines.push("-- Platforms");
platforms.forEach((name, slug) => {
  lines.push(
    `insert into public.platforms (slug, name) values (${escapeLiteral(slug)}, ${escapeLiteral(name)}) on conflict (slug) do update set name = excluded.name;`
  );
});

lines.push("-- Genres");
genres.forEach((name) => {
  lines.push(
    `insert into public.genres (name) values (${escapeLiteral(name)}) on conflict (name) do update set name = excluded.name;`
  );
});

lines.push("-- Games");
games.forEach((game) => {
  lines.push(
    `insert into public.games (name, platform_id, rating, rating_category, release_year, player_mode, region, notes, player_count, cover_url, details_url)\nselect ${escapeLiteral(game.name)}, id, ${numberLiteral(game.rating)}, ${escapeLiteral(game.ratingCategory)}, ${game.releaseYear ?? "null"}, ${escapeLiteral(game.playerMode)}, ${escapeLiteral(game.region)}, ${escapeLiteral(game.notes)}, ${escapeLiteral(game.playerCount)}, ${escapeLiteral(game.cover)}, ${escapeLiteral(game.details)}\nfrom public.platforms where slug = ${escapeLiteral(game.platformSlug)} limit 1\non conflict do nothing;`
  );

  game.genres.forEach((genreName) => {
    lines.push(
      `insert into public.game_genres (game_id, genre_id)\nselect g.id, ge.id from public.games g\njoin public.platforms p on g.platform_id = p.id\njoin public.genres ge on ge.name = ${escapeLiteral(genreName)}\nwhere g.name = ${escapeLiteral(game.name)} and p.slug = ${escapeLiteral(game.platformSlug)}\non conflict do nothing;`
    );
  });

  if (game.cover) {
    lines.push(
      `insert into public.game_media (game_id, media_url, media_type)\nselect g.id, ${escapeLiteral(game.cover)}, 'image' from public.games g\njoin public.platforms p on g.platform_id = p.id\nwhere g.name = ${escapeLiteral(game.name)} and p.slug = ${escapeLiteral(game.platformSlug)}\non conflict do nothing;`
    );
  }
});

lines.push("commit;");

fs.mkdirSync(path.dirname(outputPath), { recursive: true });
fs.writeFileSync(outputPath, lines.join("\n") + "\n", "utf8");

console.log(`Seed SQL written to ${path.relative(ROOT, outputPath)}`);
